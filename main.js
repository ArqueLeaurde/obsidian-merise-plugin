"use strict";var A=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var ne=Object.prototype.hasOwnProperty;var ie=(o,a)=>{for(var i in a)A(o,i,{get:a[i],enumerable:!0})},se=(o,a,i,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let e of te(a))!ne.call(o,e)&&e!==i&&A(o,e,{get:()=>a[e],enumerable:!(t=ee(a,e))||t.enumerable});return o};var re=o=>se(A({},"__esModule",{value:!0}),o);var Ce={};ie(Ce,{default:()=>D});module.exports=re(Ce);var h=require("obsidian");var R={inheritanceStrategy:"table_per_class",sqlDialect:"mysql",defaultVarcharLength:255};function k(o){let a=[],i=[],t={entities:[],relations:[],inheritances:[],associativeEntities:[]},e=oe(o);for(let n of e)switch(n.keyword.toUpperCase()){case"ENTITY":ce(n,t,a);break;case"RELATION":le(n,t,a);break;case"INHERITANCE":fe(n,t,a);break;case"ASSOCIATIVE":me(n,t,a);break;default:a.push(`Mot-cl\xE9 inconnu : "${n.keyword}"`)}let s=new Set;for(let n of t.relations)for(let r of n.participants)s.add(r.entityName);for(let n of t.inheritances){s.add(n.parentEntity);for(let r of n.childEntities)s.add(r)}for(let n of t.entities)s.has(n.name)||i.push(`Entit\xE9 orpheline d\xE9tect\xE9e : "${n.name}" n'appara\xEEt dans aucune relation.`);return{model:t,errors:a,warnings:i}}function oe(o){let a=[],i=o.split(`
`),t=0;for(;t<i.length;){let e=i[t].trim();if(!e||e.startsWith("//")||e.startsWith("#")){t++;continue}let s=e.match(/^(\w+)\s+(\w+)\s*(.*?)\s*\{?\s*$/);if(!s){t++;continue}let n=s[1],r=s[2],c=s[3]||"",l="";if(e.includes("{")){let d=e.substring(e.indexOf("{")+1).trim();if(d.endsWith("}")){l=d.slice(0,-1).trim(),a.push({keyword:n,name:r,extra:c,body:l}),t++;continue}l=d?d+`
`:"",t++;let m=1;for(;t<i.length&&m>0;){let M=i[t];for(let v of M)if(v==="{"&&m++,v==="}"&&m--,m===0)break;if(m>0)l+=M+`
`;else{let v=M.indexOf("}");l+=M.substring(0,v)+`
`}t++}}else{for(t++;t<i.length&&!i[t].trim().startsWith("{");)t++;if(t<i.length){t++;let d=1;for(;t<i.length&&d>0;){let m=i[t];for(let M of m)if(M==="{"&&d++,M==="}"&&d--,d===0)break;if(d>0)l+=m+`
`;else{let M=m.indexOf("}");l+=m.substring(0,M)+`
`}t++}}}a.push({keyword:n,name:r,extra:c.replace("{","").trim(),body:l.trim()})}return a}function ae(o){let a=[],i="",t=0;for(let s of o)if(s==="("||s==="[")t++,i+=s;else if(s===")"||s==="]")t--,i+=s;else if(s===","&&t===0){let n=i.trim();n&&a.push(n),i=""}else i+=s;let e=i.trim();return e&&a.push(e),a}function I(o){let a=[],i=o.split(`
`);for(let t of i){let e=t.trim();if(!e)continue;let s=ae(e);for(let n of s){let r=n.replace(/,\s*$/,"").trim();r&&a.push(r)}}return a}function ce(o,a,i){let t={name:o.name,attributes:[]},e=I(o.body);for(let s of e){let n=B(s);n&&t.attributes.push(n)}t.attributes.filter(s=>s.isPrimaryKey).length===0&&i.push(`Entit\xE9 "${t.name}" n'a pas d'identifiant [PK].`),a.entities.push(t)}function B(o){let a=o.match(/^(\w+)\s*(\[.*\])?\s*$/);if(!a)return null;let i=a[1],t=a[2]||"";return{name:i,isPrimaryKey:t.includes("PK"),isDerived:t.includes("DERIVED")}}function le(o,a,i){let t={name:o.name,participants:[],attributes:[]},e=I(o.body);for(let s of e){let n=s.match(/^(\w+)\s*\(\s*([\d],[n\d])\s*\)$/);if(n){let c=n[1],l=n[2];if(!de(l)){i.push(`Cardinalit\xE9 invalide "${l}" pour l'entit\xE9 "${c}" dans la relation "${o.name}".`);continue}t.participants.push({entityName:c,cardinality:l});continue}let r=B(s);r&&t.attributes.push(r)}t.participants.length<2&&i.push(`La relation "${o.name}" doit avoir au moins 2 participants (trouv\xE9: ${t.participants.length}).`),a.relations.push(t)}function de(o){return["0,1","1,1","0,n","1,n"].includes(o)}function fe(o,a,i){let t={name:o.name,parentEntity:"",childEntities:[]},e=o.body.split(`
`);for(let s of e){let n=s.trim().replace(/,\s*$/,"");if(!n)continue;let r=n.match(/^PARENT\s+(\w+)$/i);if(r){t.parentEntity=r[1];continue}let c=n.match(/^CHILDREN\s+(.+)$/i);if(c){t.childEntities=c[1].split(",").map(d=>d.trim()).filter(d=>d.length>0);continue}let l=n.match(/^STRATEGY\s+(\w+)$/i);if(l){let d=l[1];["table_per_class","single_table","table_per_subclass"].includes(d)?t.strategy=d:i.push(`Strat\xE9gie d'h\xE9ritage inconnue : "${d}".`);continue}}t.parentEntity||i.push(`H\xE9ritage "${o.name}" : PARENT non d\xE9fini.`),t.childEntities.length===0&&i.push(`H\xE9ritage "${o.name}" : aucun CHILDREN d\xE9fini.`),a.inheritances.push(t)}function me(o,a,i){let t=o.extra.match(/^ON\s+(\w+)$/i);if(!t){i.push(`Entit\xE9 associative "${o.name}" : mot-cl\xE9 ON manquant (syntaxe: ASSOCIATIVE nom ON relation { ... }).`);return}let e={name:o.name,relationName:t[1],attributes:[]},s=I(o.body);for(let n of s){let r=B(n);r&&e.attributes.push(r)}a.associativeEntities.push(e)}function _(o){let a=[],i={tables:[]},t=o.split(`
`),e=0;for(;e<t.length;){let n=t[e].trim().match(/^TABLE\s+(\w+)\s*\{?\s*$/i);if(n){let r={name:n[1],columns:[]};for(e++;e<t.length;){let c=t[e].trim();if(c==="}"||c===""){if(c==="}"){e++;break}e++;continue}let l=pe(c);if(l)r.columns.push(l);else{if(c.includes("}")){e++;break}a.push(`Colonne MLD invalide : "${c}" dans la table "${r.name}".`)}e++}i.tables.push(r);continue}e++}return{model:i,errors:a}}function pe(o){let i=o.replace(/,\s*$/,"").trim().match(/^(\w+)\s*(.*)?$/);if(!i)return null;let t=i[1],e=i[2]||"",s=/\[PK\]/i.test(e),n,r=e.match(/\[FK\s*->\s*(\w+)\.(\w+)\]/i);return r&&(n={columnName:t,referencedTable:r[1],referencedColumn:r[2]}),{name:t,isPrimaryKey:s,foreignKey:n}}function U(o){let a=[],i={tables:[]},t=o.split(`
`),e=0;for(;e<t.length;){let n=t[e].trim().match(/^TABLE\s+(\w+)\s*\{?\s*$/i);if(n){let r={name:n[1],columns:[]};for(e++;e<t.length;){let c=t[e].trim();if(c==="}"||c.startsWith("}")){e++;break}if(c===""){e++;continue}let l=ue(c,a,r.name);l&&r.columns.push(l),e++}i.tables.push(r);continue}e++}return{model:i,errors:a}}function ue(o,a,i){let t=o.replace(/,\s*$/,"").trim(),e=t.match(/^(\w+)\s+(\w+(?:\(\d+(?:,\d+)?\))?)\s*(.*)?$/);if(!e)return a.push(`Colonne MPD invalide dans "${i}" : "${t}".`),null;let s=e[1],n=e[2],r=e[3]||"",c=/\[PK\]/i.test(r),l=[];/\[NOT\s*NULL\]/i.test(r)&&l.push({type:"NOT NULL"}),/\[UNIQUE\]/i.test(r)&&l.push({type:"UNIQUE"});let d=r.match(/\[CHECK\(([^)]+)\)\]/i);d&&l.push({type:"CHECK",expression:d[1]});let m,M=r.match(/\[FK\s*->\s*(\w+)\.(\w+)(?:\s+ON\s+DELETE\s+(\w+(?:\s+\w+)?))?(?:\s+ON\s+UPDATE\s+(\w+(?:\s+\w+)?))?\]/i);return M&&(m={columnName:s,referencedTable:M[1],referencedColumn:M[2],onDelete:W(M[3]),onUpdate:W(M[4])}),{name:s,sqlType:n,isPrimaryKey:c,foreignKey:m,constraints:l}}function W(o){if(!o)return;let a=o.toUpperCase().trim();return["CASCADE","SET NULL","SET DEFAULT","RESTRICT","NO ACTION"].find(t=>t===a)}function F(o){var d,m,M,v;let a=new Map;for(let f of o.entities)a.set(f.name,0);for(let f of o.associativeEntities)a.set(f.name,0);for(let f of o.relations)for(let p of f.participants)a.set(p.entityName,((d=a.get(p.entityName))!=null?d:0)+1);for(let f of o.inheritances){a.set(f.parentEntity,((m=a.get(f.parentEntity))!=null?m:0)+f.childEntities.length);for(let p of f.childEntities)a.set(p,((M=a.get(p))!=null?M:0)+1)}let i=[],t=[],e=[];for(let f of o.entities){let p=(v=a.get(f.name))!=null?v:0;p>=5?e.push(f):p>=3?t.push(f):i.push(f)}let s=o.associativeEntities,n=["%%{init: {'theme':'base','flowchart':{'curve':'stepAfter','ranker':'longest-path','nodeSpacing':60,'rankSpacing':120,'padding':30,'useMaxWidth':false},'themeVariables':{'primaryColor':'#e3f2fd','primaryBorderColor':'#1565c0','edgeLabelBackground':'#ffffff','tertiaryColor':'#fff9c4','lineColor':'#455a64','textColor':'#333333'}}}%%","graph TD","","    %% Styles par calque","    classDef satellite fill:#f5f5f5,stroke:#bdbdbd,stroke-width:2px,color:#424242,rx:4,ry:4","    classDef master fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#212121,rx:4,ry:4","    classDef hub fill:#bbdefb,stroke:#0d47a1,stroke-width:3px,color:#0d47a1,rx:4,ry:4","    classDef relation fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#212121","    classDef inheritance fill:#fce4ec,stroke:#c62828,stroke-width:2px,color:#212121","    classDef assocEntity fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#212121",""],r=(f,p)=>{let g=[];for(let u of f.attributes)u.isPrimaryKey?g.push(`<u>${w(u.name)}</u>`):u.isDerived?g.push(`<i>/${w(u.name)}/</i>`):g.push(w(u.name));let T=`<b>${w(f.name)}</b>`;return g.length>0&&(T+=`<br/>\u2500\u2500\u2500\u2500<br/>${g.join("<br/>")}`),`${y(f.name)}["${T}"]:::${p}`},c=f=>{if(f.length!==0){for(let p of f)n.push(`        ${p.decl}`);if(f.length>=2){let p=f.map(g=>g.id).join(" ~~~ ");n.push(`        ${p}`)}}};if(i.length>0){let f=i.map(p=>({id:y(p.name),decl:r(p,"satellite")}));n.push("    %% Calque 1 : Satellites (r\xE9f\xE9rentiels)"),n.push('    subgraph Satellite_Layer[" "]'),n.push("        direction LR"),c(f),n.push("    end"),n.push("    style Satellite_Layer fill:none,stroke:none"),n.push("")}if(t.length>0||s.length>0){let f=[];for(let p of t)f.push({id:y(p.name),decl:r(p,"master")});for(let p of s){let g=p.attributes.map(u=>u.isPrimaryKey?`<u>${w(u.name)}</u>`:w(u.name)),T=`<b>${w(p.name)}</b>`;g.length>0&&(T+=`<br/>\u2500\u2500\u2500\u2500<br/>${g.join("<br/>")}`),f.push({id:y(p.name),decl:`${y(p.name)}["${T}"]:::assocEntity`})}n.push("    %% Calque 2 : Ma\xEEtres (entit\xE9s structurantes)"),n.push('    subgraph Master_Layer[" "]'),n.push("        direction LR"),c(f),n.push("    end"),n.push("    style Master_Layer fill:none,stroke:none"),n.push("")}if(e.length>0){let f=e.map(p=>({id:y(p.name),decl:r(p,"hub")}));n.push("    %% Calque 3 : Hubs (transactions centrales)"),n.push('    subgraph Hub_Layer[" "]'),n.push("        direction LR"),c(f),n.push("    end"),n.push("    style Hub_Layer fill:none,stroke:none"),n.push("")}if(i.length===0&&t.length===0&&e.length===0){n.push("    %% Entit\xE9s");for(let f of o.entities)n.push(`    ${r(f,"master")}`);n.push("")}n.push("    %% Relations");for(let f of o.relations){let p=`rel_${y(f.name)}`,g=[w(f.name)];for(let T of f.attributes)g.push(w(T.name));n.push(`    ${p}{"${g.join("<br/>")}"}:::relation`)}n.push(""),n.push("    %% Liens");for(let f of o.relations){let p=`rel_${y(f.name)}`;for(let g of f.participants)n.push(`    ${y(g.entityName)} ---|${g.cardinality}| ${p}`)}if(o.inheritances.length>0){n.push(""),n.push("    %% H\xE9ritage");for(let f of o.inheritances){let p=`inh_${y(f.name)}`;n.push(`    ${p}(["${w(f.name)} IS-A"]):::inheritance`),n.push(`    ${y(f.parentEntity)} --- ${p}`);for(let g of f.childEntities)n.push(`    ${p} --- ${y(g)}`)}}if(s.length>0){n.push(""),n.push("    %% Liens associatifs");for(let f of s){let p=o.relations.find(g=>g.name===f.relationName);p&&n.push(`    ${y(f.name)} -.-|associ\xE9e| rel_${y(p.name)}`)}}n.push(""),n.push("    linkStyle default stroke-width:1px,fill:none,stroke:#333333");let l=[];if(i.length>0&&l.push(y(i[0].name)),t.length>0?l.push(y(t[0].name)):s.length>0&&l.push(y(s[0].name)),e.length>0&&l.push(y(e[0].name)),l.length>=2){n.push(""),n.push("    %% Ancrage vertical (liens invisibles)");for(let f=0;f<l.length-1;f++)n.push(`    ${l[f]} ~~~ ${l[f+1]}`)}return n.join(`
`)}function w(o){return o.replace(/"/g,"'").replace(/&/g,"&amp;")}function y(o){return o.replace(/[^a-zA-Z0-9_]/g,"_")}function j(o){let a=['%%{init: {"theme": "base", "themeVariables": {"primaryColor": "#e3f2fd", "primaryBorderColor": "#1565c0", "lineColor": "#555555", "edgeLabelBackground": "#ffffff"}, "er": {"layoutDirection": "TB", "useMaxWidth": false, "entityPadding": 15, "fontSize": 13}}}%%',"erDiagram"];for(let t of o.tables){a.push(`    ${t.name} {`);for(let e of t.columns){let s=[];e.isPrimaryKey&&s.push("PK"),e.foreignKey&&s.push("FK");let n=s.length>0?` "${s.join(", ")}"`:"",r=e.isPrimaryKey?"id":e.foreignKey?"ref":"string";a.push(`        ${r} ${e.name}${n}`)}a.push("    }")}let i=new Set;for(let t of o.tables)for(let e of t.columns)if(e.foreignKey){let s=`${t.name}.${e.name}->${e.foreignKey.referencedTable}.${e.foreignKey.referencedColumn}`;if(!i.has(s)){i.add(s);let n=e.isPrimaryKey?"}|":"}o";a.push(`    ${e.foreignKey.referencedTable} ||--${n} ${t.name} : "${e.name}"`)}}return a.join(`
`)}function Q(o){let a=['%%{init: {"theme": "base", "themeVariables": {"primaryColor": "#f3e5f5", "primaryBorderColor": "#7b1fa2", "primaryTextColor": "#4a148c", "lineColor": "#6a1b9a", "edgeLabelBackground": "#ffffff"}, "er": {"layoutDirection": "TB", "useMaxWidth": false, "entityPadding": 15, "fontSize": 13}}}%%',"erDiagram"];for(let i of o.tables){a.push(`    ${i.name} {`);for(let t of i.columns){let e=[];t.isPrimaryKey&&e.push("PK"),t.foreignKey&&e.push("FK");for(let r of t.constraints)r.type==="NOT NULL"&&!t.isPrimaryKey&&e.push("NN"),r.type==="UNIQUE"&&e.push("UQ"),r.type==="CHECK"&&e.push("CHK");let s=e.length>0?` "${e.join(", ")}"`:"",n=t.sqlType.replace(/\(/g,"_").replace(/\)/g,"").replace(/,/g,"-");a.push(`        ${n} ${t.name}${s}`)}a.push("    }")}return a.join(`
`)}function O(o,a="table_per_class"){let i={tables:[]},t=new Map;for(let s of o.entities)t.set(s.name,s);let e=he(o.relations);for(let s of o.entities){let n={name:s.name,columns:s.attributes.filter(r=>!r.isDerived).map(r=>({name:r.name,isPrimaryKey:r.isPrimaryKey}))};i.tables.push(n)}for(let s of o.relations)s.participants.length===2?Me(s,i,t,e):ye(s,i,t);for(let s of o.inheritances){let n=s.strategy||a;be(s.parentEntity,s.childEntities,n,i,t)}for(let s of o.associativeEntities){let n=o.relations.find(c=>c.name===s.relationName);if(!n)continue;let r=i.tables.find(c=>c.name===n.name||c.name===s.name);if(!r){r={name:s.name,columns:[]};for(let c of n.participants){let l=N(t.get(c.entityName));l&&r.columns.push({name:l,isPrimaryKey:!0,foreignKey:{columnName:l,referencedTable:c.entityName,referencedColumn:l}})}i.tables.push(r)}for(let c of s.attributes)r.columns.find(l=>l.name===c.name)||r.columns.push({name:c.name,isPrimaryKey:c.isPrimaryKey})}return i}function he(o){let a=new Map;for(let i of o)if(i.participants.length===2){let t=X(i.participants[0].entityName,i.participants[1].entityName);a.set(t,(a.get(t)||0)+1)}return a}function X(o,a){return[o,a].sort().join("|")}function ge(o,a){if(o.participants.length!==2)return!1;let i=X(o.participants[0].entityName,o.participants[1].entityName);return(a.get(i)||0)>1}function Me(o,a,i,t){let e=o.participants[0],s=o.participants[1],n=l=>l==="0,n"||l==="1,n",r=l=>l==="0,1"||l==="1,1",c=ge(o,t);r(e.cardinality)&&n(s.cardinality)?(L(a,e.entityName,s.entityName,i,c?o.name:void 0),P(a,e.entityName,o)):n(e.cardinality)&&r(s.cardinality)?(L(a,s.entityName,e.entityName,i,c?o.name:void 0),P(a,s.entityName,o)):r(e.cardinality)&&r(s.cardinality)?e.cardinality==="1,1"?(L(a,e.entityName,s.entityName,i,c?o.name:void 0),P(a,e.entityName,o)):(L(a,s.entityName,e.entityName,i,c?o.name:void 0),P(a,s.entityName,o)):Y(o,a,i)}function ye(o,a,i){Y(o,a,i)}function Y(o,a,i){var s;let t={name:o.name,columns:[]},e=new Map;for(let n of o.participants){let r=N(i.get(n.entityName));r&&(e.has(r)||e.set(r,[]),e.get(r).push(n.entityName))}for(let n of o.participants){let r=N(i.get(n.entityName));if(r){let l=(((s=e.get(r))==null?void 0:s.length)||0)>1?`${r}_${n.entityName.toLowerCase()}`:r;t.columns.push({name:l,isPrimaryKey:!0,foreignKey:{columnName:l,referencedTable:n.entityName,referencedColumn:r}})}}for(let n of o.attributes)t.columns.push({name:n.name,isPrimaryKey:!1});a.tables.push(t)}function be(o,a,i,t,e){let s=N(e.get(o));if(s)switch(i){case"table_per_class":{for(let n of a){let r=t.tables.find(c=>c.name===n);if(r&&!r.columns.find(c=>{var l;return((l=c.foreignKey)==null?void 0:l.referencedTable)===o})&&(r.columns.unshift({name:s,isPrimaryKey:!0,foreignKey:{columnName:s,referencedTable:o,referencedColumn:s}}),r.columns.filter(l=>l.name===s).length>1)){let l=r.columns.findIndex(d=>d.name===s&&!d.foreignKey);l>=0&&r.columns.splice(l,1)}}break}case"single_table":{let n=t.tables.find(r=>r.name===o);if(!n)break;n.columns.find(r=>r.name==="type_discriminator")||n.columns.push({name:"type_discriminator",isPrimaryKey:!1});for(let r of a){let c=e.get(r);if(c)for(let d of c.attributes)!d.isPrimaryKey&&!n.columns.find(m=>m.name===d.name)&&n.columns.push({name:d.name,isPrimaryKey:!1});let l=t.tables.findIndex(d=>d.name===r);l>=0&&t.tables.splice(l,1)}break}case"table_per_subclass":{let n=e.get(o);if(!n)break;for(let c of a){let l=t.tables.find(d=>d.name===c);if(l)for(let d of n.attributes)l.columns.find(m=>m.name===d.name)||l.columns.unshift({name:d.name,isPrimaryKey:d.isPrimaryKey})}let r=t.tables.findIndex(c=>c.name===o);r>=0&&t.tables.splice(r,1);break}}}function N(o){if(!o)return null;let a=o.attributes.find(i=>i.isPrimaryKey);return a?a.name:null}function L(o,a,i,t,e){let s=o.tables.find(l=>l.name===a),n=t.get(i);if(!s||!n)return;let r=N(n);if(!r)return;let c=e?`${r}_${e}`:r;s.columns.find(l=>l.name===c)||s.columns.push({name:c,isPrimaryKey:!1,foreignKey:{columnName:c,referencedTable:i,referencedColumn:r}})}function P(o,a,i){let t=o.tables.find(e=>e.name===a);if(t)for(let e of i.attributes)t.columns.find(s=>s.name===e.name)||t.columns.push({name:e.name,isPrimaryKey:!1})}function V(o,a="mysql",i=255){let t={tables:[]},e=new Map;for(let s of o.tables)for(let n of s.columns)if(!n.foreignKey){let r=q(n.name,n.isPrimaryKey,a,i);e.set(`${s.name}.${n.name}`,r)}for(let s of o.tables)for(let n of s.columns)if(n.foreignKey){let r=`${n.foreignKey.referencedTable}.${n.foreignKey.referencedColumn}`,c=e.get(r);c?c==="SERIAL"&&(c="INT"):c=q(n.foreignKey.referencedColumn,!1,a,i),e.set(`${s.name}.${n.name}`,c)}for(let s of o.tables){let n={name:s.name,columns:[]};for(let r of s.columns){let c=e.get(`${s.name}.${r.name}`)||q(r.name,r.isPrimaryKey,a,i),l=[];r.isPrimaryKey&&l.push({type:"NOT NULL"}),r.name.toLowerCase().includes("email")&&l.push({type:"UNIQUE"});let d={name:r.name,sqlType:c,isPrimaryKey:r.isPrimaryKey,constraints:l};r.foreignKey&&(d.foreignKey={columnName:r.foreignKey.columnName,referencedTable:r.foreignKey.referencedTable,referencedColumn:r.foreignKey.referencedColumn,onDelete:"CASCADE",onUpdate:"CASCADE"},l.find(m=>m.type==="NOT NULL")||l.push({type:"NOT NULL"})),n.columns.push(d)}t.tables.push(n)}return t}function q(o,a,i,t){let e=o.toLowerCase();return a&&(e.startsWith("id")||e.endsWith("id"))?i==="postgresql"?"SERIAL":"INT":e.startsWith("id_")||e.endsWith("_id")||e==="id"?"INT":e.startsWith("ref_")||e.endsWith("_ref")||e==="ref"?"VARCHAR(20)":e.includes("datetime")||e.includes("timestamp")?i==="postgresql"?"TIMESTAMP":"DATETIME":e.startsWith("date_")||e.endsWith("_date")||e==="date"?"DATE":e.startsWith("prix")||e.startsWith("montant")||e.startsWith("total")||e.startsWith("price")||e.startsWith("amount")?"DECIMAL(10,2)":e.startsWith("quantite")||e.startsWith("nombre")||e.startsWith("nb_")||e.startsWith("quantity")||e.startsWith("count")||e.startsWith("num_")?"INT":e.endsWith("_bool")||e.startsWith("est_")||e.startsWith("is_")||e.startsWith("has_")||e.startsWith("a_")?"BOOLEAN":e==="description"||e==="contenu"||e==="content"||e==="commentaire"?"TEXT":e==="type_discriminator"||e==="type"?"VARCHAR(50)":`VARCHAR(${t})`}function z(o,a="mysql"){let i=[];i.push("-- ============================================"),i.push("-- Script SQL g\xE9n\xE9r\xE9 par le plugin Merise"),i.push(`-- Dialecte : ${a.toUpperCase()}`),i.push("-- ============================================"),i.push("");let t=ve(o.tables);for(let e of t)i.push(Ee(e,a)),i.push("");return i.join(`
`)}function Ee(o,a){let i=a==="postgresql"?'"':"`",t=[];t.push(`CREATE TABLE ${i}${o.name}${i} (`);let e=[],s=[],n=[];for(let c of o.columns){let l=`    ${i}${c.name}${i} ${Te(c.sqlType,a)}`;for(let d of c.constraints)switch(d.type){case"NOT NULL":l+=" NOT NULL";break;case"UNIQUE":l+=" UNIQUE";break;case"CHECK":d.expression&&(l+=` CHECK (${d.expression})`);break}if(c.isPrimaryKey&&a==="mysql"&&c.sqlType==="INT"&&(c.name.toLowerCase().startsWith("id")||c.name.toLowerCase().endsWith("id"))&&!c.foreignKey&&(l+=" AUTO_INCREMENT"),e.push(l),c.isPrimaryKey&&s.push(`${i}${c.name}${i}`),c.foreignKey){let d=c.foreignKey,m=`    FOREIGN KEY (${i}${d.columnName}${i}) REFERENCES ${i}${d.referencedTable}${i}(${i}${d.referencedColumn}${i})`;d.onDelete&&(m+=` ON DELETE ${d.onDelete}`),d.onUpdate&&(m+=` ON UPDATE ${d.onUpdate}`),n.push(m)}}let r=[...e];return s.length>0&&r.push(`    PRIMARY KEY (${s.join(", ")})`),r.push(...n),t.push(r.join(`,
`)),t.push(");"),t.join(`
`)}function Te(o,a){if(a==="postgresql"){if(o==="DATETIME")return"TIMESTAMP";if(o==="DOUBLE")return"DOUBLE PRECISION"}if(a==="mysql"){if(o==="SERIAL")return"INT";if(o==="BOOLEAN")return"TINYINT(1)"}return o}function ve(o){let a=new Map,i=new Map;for(let n of o)a.set(n.name,n),i.set(n.name,new Set);for(let n of o)for(let r of n.columns)if(r.foreignKey){let c=r.foreignKey.referencedTable;c!==n.name&&a.has(c)&&i.get(n.name).add(c)}let t=[],e=new Set,s=new Set(a.keys());for(;s.size>0;){let n=[];for(let r of s)[...i.get(r)].filter(d=>!e.has(d)).length===0&&n.push(r);if(n.length===0){for(let r of s)t.push(a.get(r));break}for(let r of n)t.push(a.get(r)),e.add(r),s.delete(r)}return t}function G(o){let a=[];for(let e of o.entities)e.attributes.some(n=>n.isPrimaryKey)||a.push({level:"error",message:`Entit\xE9 "${e.name}" : aucun identifiant [PK] d\xE9fini.`});let i=new Set;for(let e of o.relations)for(let s of e.participants)i.add(s.entityName);for(let e of o.inheritances)i.add(e.parentEntity),e.childEntities.forEach(s=>i.add(s));for(let e of o.entities)i.has(e.name)||a.push({level:"warning",message:`Entit\xE9 orpheline : "${e.name}" n'appara\xEEt dans aucune relation.`});let t=new Set(o.entities.map(e=>e.name));for(let e of o.relations)for(let s of e.participants)t.has(s.entityName)||a.push({level:"error",message:`Relation "${e.name}" : entit\xE9 "${s.entityName}" non d\xE9finie.`});for(let e of o.inheritances){t.has(e.parentEntity)||a.push({level:"error",message:`H\xE9ritage "${e.name}" : entit\xE9 parent "${e.parentEntity}" non d\xE9finie.`});for(let s of e.childEntities)t.has(s)||a.push({level:"error",message:`H\xE9ritage "${e.name}" : entit\xE9 enfant "${s}" non d\xE9finie.`})}for(let e of o.relations)e.participants.length<2&&a.push({level:"error",message:`Relation "${e.name}" : doit avoir au moins 2 participants.`});return a}function Z(o){let a=[],i=new Set(o.tables.map(e=>e.name));for(let e of o.tables){e.columns.some(n=>n.isPrimaryKey)||a.push({level:"warning",message:`Table "${e.name}" : aucune cl\xE9 primaire d\xE9finie.`});for(let n of e.columns)n.foreignKey&&!i.has(n.foreignKey.referencedTable)&&a.push({level:"error",message:`Table "${e.name}", colonne "${n.name}" : FK vers table inexistante "${n.foreignKey.referencedTable}".`})}let t=we(o);for(let e of t)a.push({level:"warning",message:`Cycle de r\xE9f\xE9rences FK d\xE9tect\xE9 : ${e.join(" \u2192 ")}.`});return a}function J(o){let a=[],i=new Set(o.tables.map(t=>t.name));for(let t of o.tables)for(let e of t.columns)e.foreignKey&&!i.has(e.foreignKey.referencedTable)&&a.push({level:"error",message:`Table "${t.name}", colonne "${e.name}" : FK vers table inexistante "${e.foreignKey.referencedTable}".`});return a}function we(o){let a=new Map;for(let r of o.tables){a.has(r.name)||a.set(r.name,[]);for(let c of r.columns)c.foreignKey&&a.get(r.name).push(c.foreignKey.referencedTable)}let i=[],t=new Set,e=new Set,s=[];function n(r){t.add(r),e.add(r),s.push(r);let c=a.get(r)||[];for(let l of c)if(!t.has(l))n(l);else if(e.has(l)){let d=s.indexOf(l);d>=0&&i.push([...s.slice(d),l])}s.pop(),e.delete(r)}for(let r of o.tables)t.has(r.name)||n(r.name);return i}var x=require("obsidian"),K=class extends x.PluginSettingTab{constructor(a,i){super(a,i),this.plugin=i}display(){let{containerEl:a}=this;a.empty(),a.createEl("h2",{text:"Merise Modeling \u2014 Param\xE8tres"}),new x.Setting(a).setName("Strat\xE9gie d'h\xE9ritage").setDesc("Strat\xE9gie utilis\xE9e lors de la conversion MCD \u2192 MLD pour les h\xE9ritages.").addDropdown(i=>{i.addOption("table_per_class","Table par classe (d\xE9faut)").addOption("single_table","Table unique").addOption("table_per_subclass","Table par sous-classe").setValue(this.plugin.settings.inheritanceStrategy).onChange(async t=>{this.plugin.settings.inheritanceStrategy=t,await this.plugin.saveSettings()})}),new x.Setting(a).setName("Dialecte SQL").setDesc("Dialecte SQL utilis\xE9 pour la g\xE9n\xE9ration du MPD et l'export SQL.").addDropdown(i=>{i.addOption("mysql","MySQL").addOption("postgresql","PostgreSQL").setValue(this.plugin.settings.sqlDialect).onChange(async t=>{this.plugin.settings.sqlDialect=t,await this.plugin.saveSettings()})}),new x.Setting(a).setName("Longueur VARCHAR par d\xE9faut").setDesc("Longueur par d\xE9faut pour les colonnes VARCHAR lors de la conversion MLD \u2192 MPD.").addText(i=>{i.setPlaceholder("255").setValue(String(this.plugin.settings.defaultVarcharLength)).onChange(async t=>{let e=parseInt(t,10);!isNaN(e)&&e>0&&(this.plugin.settings.defaultVarcharLength=e,await this.plugin.saveSettings())})})}};var D=class extends h.Plugin{constructor(){super(...arguments);this.settings=R}async onload(){await this.loadSettings(),this.registerMarkdownCodeBlockProcessor("merise-mcd",(i,t,e)=>{this.processMcdBlock(i,t,e)}),this.registerMarkdownCodeBlockProcessor("merise-mld",(i,t,e)=>{this.processMldBlock(i,t,e)}),this.registerMarkdownCodeBlockProcessor("merise-mpd",(i,t,e)=>{this.processMpdBlock(i,t,e)}),this.addCommand({id:"merise-convert-mcd-to-mld",name:"Merise : Convertir MCD \u2192 MLD",callback:()=>this.commandConvertMcdToMld()}),this.addCommand({id:"merise-convert-mld-to-mpd",name:"Merise : Convertir MLD \u2192 MPD",callback:()=>this.commandConvertMldToMpd()}),this.addCommand({id:"merise-convert-mcd-to-mpd",name:"Merise : Convertir MCD \u2192 MLD \u2192 MPD (complet)",callback:()=>this.commandConvertMcdToMpd()}),this.addCommand({id:"merise-export-sql",name:"Merise : Exporter SQL depuis MPD",callback:()=>this.commandExportSql()}),this.addSettingTab(new K(this.app,this)),new h.Notice("Plugin Merise charg\xE9 \u2713")}async loadSettings(){this.settings=Object.assign({},R,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}processMcdBlock(i,t,e){let{model:s,errors:n,warnings:r}=k(i);if(n.length>0){this.renderMessages(t,n,"error");return}let c=G(s);this.renderMessages(t,r,"warning"),this.renderValidationMessages(t,c);let l=F(s);this.renderMermaid(t,l,"MCD")}processMldBlock(i,t,e){let{model:s,errors:n}=_(i);if(n.length>0){this.renderMessages(t,n,"error");return}let r=Z(s);this.renderValidationMessages(t,r);let c=j(s);this.renderMermaid(t,c,"MLD")}processMpdBlock(i,t,e){let{model:s,errors:n}=U(i);if(n.length>0){this.renderMessages(t,n,"error");return}let r=J(s);this.renderValidationMessages(t,r);let c=Q(s);this.renderMermaid(t,c,"MPD")}renderMermaid(i,t,e){let s=i.createDiv({cls:"merise-diagram-container"});s.createEl("div",{cls:"merise-diagram-label",text:`\u{1F4CA} ${e}`});let n=s.createDiv({cls:"merise-toolbar"});n.createEl("button",{text:"\u{1F4CB} Copier Mermaid"}).addEventListener("click",()=>{navigator.clipboard.writeText(t),new h.Notice("Code Mermaid copi\xE9 !")});let c=n.createEl("button",{text:"\u{1F4E5} Exporter PNG"}),l=n.createEl("button",{text:"\u{1F504} Reset zoom"}),d=s.createDiv({cls:"merise-graph-container"}),m=d.createDiv({cls:"merise-graph-inner"}),M=d.createDiv({cls:"merise-zoom-indicator"});M.textContent="100%",this.renderMermaidDiagram(m,t).then(()=>{this.attachPanZoom(d,m,M,l),c.addEventListener("click",()=>{this.exportPng(m,e)})})}async renderMermaidDiagram(i,t){try{let e=window.mermaid;if(e){let s="merise-"+Math.random().toString(36).substring(2,9),{svg:n}=await e.render(s,t);i.innerHTML=n}else this.renderFallbackCode(i,t)}catch(e){let s=i.createDiv({cls:"merise-render-error"});s.textContent=`\u26A0\uFE0F Erreur de rendu Mermaid : ${e}`,this.renderFallbackCode(i,t)}}renderFallbackCode(i,t){let e=i.createEl("pre",{cls:"merise-fallback-code"});e.createEl("code").textContent=t}attachPanZoom(i,t,e,s){let n=1,r=0,c=0,l=!1,d=0,m=0,M=.1,v=5,f=.001,p=()=>{t.style.transform=`translate(${r}px, ${c}px) scale(${n})`,e.textContent=`${Math.round(n*100)}%`};i.addEventListener("wheel",u=>{u.preventDefault(),u.stopPropagation();let b=-u.deltaY*f,E=Math.min(v,Math.max(M,n*(1+b))),$=i.getBoundingClientRect(),S=u.clientX-$.left,C=u.clientY-$.top,H=E/n;r=S-H*(S-r),c=C-H*(C-c),n=E,p()},{passive:!1}),i.addEventListener("mousedown",u=>{u.button===0&&(l=!0,d=u.clientX-r,m=u.clientY-c,t.classList.remove("merise-animate-reset"))});let g=u=>{l&&(r=u.clientX-d,c=u.clientY-m,p())},T=()=>{l=!1};document.addEventListener("mousemove",g),document.addEventListener("mouseup",T),i.addEventListener("touchstart",u=>{u.touches.length===1&&(l=!0,d=u.touches[0].clientX-r,m=u.touches[0].clientY-c,t.classList.remove("merise-animate-reset"))},{passive:!0}),i.addEventListener("touchmove",u=>{!l||u.touches.length!==1||(u.preventDefault(),r=u.touches[0].clientX-d,c=u.touches[0].clientY-m,p())},{passive:!1}),i.addEventListener("touchend",()=>{l=!1}),s.addEventListener("click",()=>{n=1,r=0,c=0,t.classList.add("merise-animate-reset"),p(),setTimeout(()=>t.classList.remove("merise-animate-reset"),350)}),requestAnimationFrame(()=>{let u=t.querySelector("svg");if(!u)return;let b=u.getBoundingClientRect(),E=i.getBoundingClientRect();(b.width>E.width||b.height>E.height)&&(n=Math.min(E.width/b.width,E.height/b.height)*.95,r=(E.width-b.width*n)/2,c=(E.height-b.height*n)/2,p())})}exportPng(i,t){let e=i.querySelector("svg");if(!e){new h.Notice("Aucun diagramme \xE0 exporter.");return}try{let s=e.getBBox(),n=50,r=s.width+n*2,c=s.height+n*2,l=e.cloneNode(!0);l.setAttribute("width",`${r}px`),l.setAttribute("height",`${c}px`),l.setAttribute("viewBox",`${s.x-n} ${s.y-n} ${r} ${c}`),l.setAttribute("xmlns","http://www.w3.org/2000/svg"),l.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),l.removeAttribute("style");let d=document.createElementNS("http://www.w3.org/2000/svg","style");d.textContent=`
                .node rect, .node circle, .node polygon { fill: #e3f2fd; stroke: #1565c0; stroke-width: 2px; }
                .node.satellite rect { fill: #f5f5f5; stroke: #bdbdbd; }
                .node.hub rect { fill: #bbdefb; stroke: #0d47a1; stroke-width: 3px; }
                .node.relation polygon { fill: #fff9c4; stroke: #fbc02d; }
                .node.assocEntity rect { fill: #e8f5e9; stroke: #2e7d32; }
                .node.inheritance rect { fill: #fce4ec; stroke: #c62828; }
                .edgePath path.path { stroke: #455a64 !important; fill: none; stroke-width: 2px; }
                .edgeLabel { background-color: #ffffff; }
                .label { font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; }
                text { fill: #333333; }
                rect.basic.label-container { stroke: #1565c0; fill: #e3f2fd; }
            `,l.prepend(d);let m=document.createElementNS("http://www.w3.org/2000/svg","rect");m.setAttribute("x",String(s.x-n)),m.setAttribute("y",String(s.y-n)),m.setAttribute("width",String(r)),m.setAttribute("height",String(c)),m.setAttribute("fill","#ffffff"),l.prepend(m);let M=new XMLSerializer().serializeToString(l),v="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(M))),f=new Image;f.onload=()=>{let g=2;(r*g>4e3||c*g>4e3)&&(g=4e3/Math.max(r,c));let T=Math.ceil(r*g),u=Math.ceil(c*g),b=document.createElement("canvas");b.width=T,b.height=u;let E=b.getContext("2d");if(!E){new h.Notice("Impossible de cr\xE9er le canvas.");return}E.fillStyle="#ffffff",E.fillRect(0,0,T,u),E.drawImage(f,0,0,T,u);try{b.toBlob($=>{if(!$){this.downloadDataUrl(b.toDataURL("image/png"),t);return}let S=URL.createObjectURL($),C=document.createElement("a");C.href=S,C.download=`merise-${t.toLowerCase()}-${Date.now()}.png`,document.body.appendChild(C),C.click(),document.body.removeChild(C),URL.revokeObjectURL(S),new h.Notice(`\u{1F4E5} ${t} export\xE9 en PNG !`)},"image/png")}catch($){this.downloadDataUrl(b.toDataURL("image/png"),t)}},f.onerror=()=>{new h.Notice("Erreur lors de l'export PNG.")},f.src=v}catch(s){new h.Notice(`Erreur export PNG : ${s}`)}}downloadDataUrl(i,t){let e=document.createElement("a");e.href=i,e.download=`merise-${t.toLowerCase()}-${Date.now()}.png`,document.body.appendChild(e),e.click(),document.body.removeChild(e),new h.Notice(`\u{1F4E5} ${t} export\xE9 en PNG !`)}renderMessages(i,t,e){if(t.length===0)return;let s=i.createDiv({cls:`merise-messages merise-${e}`}),n=e==="error"?"\u274C":"\u26A0\uFE0F";for(let r of t){let c=s.createEl("div");c.textContent=`${n} ${r}`}}renderValidationMessages(i,t){let e=t.filter(n=>n.level==="error").map(n=>n.message),s=t.filter(n=>n.level==="warning").map(n=>n.message);this.renderMessages(i,e,"error"),this.renderMessages(i,s,"warning")}async commandConvertMcdToMld(){let i=this.app.workspace.getActiveViewOfType(h.MarkdownView);if(!i){new h.Notice("Aucun fichier Markdown actif.");return}let t=i.editor,e=t.getValue(),s=this.extractCodeBlock(e,"merise-mcd");if(!s){new h.Notice("Aucun bloc merise-mcd trouv\xE9 dans le fichier.");return}let{model:n,errors:r}=k(s);if(r.length>0){new h.Notice(`Erreurs dans le MCD :
${r.join(`
`)}`);return}let c=O(n,this.settings.inheritanceStrategy),l=this.generateMldText(c),d=this.insertAfterBlock(e,"merise-mcd","merise-mld",l);t.setValue(d),new h.Notice("\u2705 Conversion MCD \u2192 MLD effectu\xE9e !")}async commandConvertMldToMpd(){let i=this.app.workspace.getActiveViewOfType(h.MarkdownView);if(!i){new h.Notice("Aucun fichier Markdown actif.");return}let t=i.editor,e=t.getValue(),s=this.extractCodeBlock(e,"merise-mld");if(!s){new h.Notice("Aucun bloc merise-mld trouv\xE9 dans le fichier.");return}let{model:n,errors:r}=_(s);if(r.length>0){new h.Notice(`Erreurs dans le MLD :
${r.join(`
`)}`);return}let c=V(n,this.settings.sqlDialect,this.settings.defaultVarcharLength),l=this.generateMpdText(c),d=this.insertAfterBlock(e,"merise-mld","merise-mpd",l);t.setValue(d),new h.Notice("\u2705 Conversion MLD \u2192 MPD effectu\xE9e !")}async commandConvertMcdToMpd(){let i=this.app.workspace.getActiveViewOfType(h.MarkdownView);if(!i){new h.Notice("Aucun fichier Markdown actif.");return}let t=i.editor,e=t.getValue(),s=this.extractCodeBlock(e,"merise-mcd");if(!s){new h.Notice("Aucun bloc merise-mcd trouv\xE9 dans le fichier.");return}let{model:n,errors:r}=k(s);if(r.length>0){new h.Notice(`Erreurs dans le MCD :
${r.join(`
`)}`);return}let c=O(n,this.settings.inheritanceStrategy),l=this.generateMldText(c);e=this.insertAfterBlock(e,"merise-mcd","merise-mld",l);let d=V(c,this.settings.sqlDialect,this.settings.defaultVarcharLength),m=this.generateMpdText(d);e=this.insertAfterBlock(e,"merise-mld","merise-mpd",m),t.setValue(e),new h.Notice("\u2705 Conversion compl\xE8te MCD \u2192 MLD \u2192 MPD effectu\xE9e !")}async commandExportSql(){let i=this.app.workspace.getActiveViewOfType(h.MarkdownView);if(!i){new h.Notice("Aucun fichier Markdown actif.");return}let t=i.editor,e=t.getValue(),s=this.extractCodeBlock(e,"merise-mpd");if(!s){new h.Notice("Aucun bloc merise-mpd trouv\xE9 dans le fichier.");return}let{model:n,errors:r}=U(s);if(r.length>0){new h.Notice(`Erreurs dans le MPD :
${r.join(`
`)}`);return}let c=z(n,this.settings.sqlDialect);await navigator.clipboard.writeText(c);let l=`

\`\`\`sql
${c}
\`\`\`
`,d=this.insertAfterBlock(e,"merise-mpd","sql",c);t.setValue(d),new h.Notice("\u2705 SQL export\xE9 et copi\xE9 dans le presse-papier !")}extractCodeBlock(i,t){let e=new RegExp("```"+t+"\\s*\\n([\\s\\S]*?)\\n```","i"),s=i.match(e);return s?s[1]:null}insertAfterBlock(i,t,e,s){let n=new RegExp("```"+e+"\\s*\\n[\\s\\S]*?\\n```","i");if(n.test(i))return i.replace(n,"```"+e+`
`+s+"\n```");let r=new RegExp("(```"+t+"\\s*\\n[\\s\\S]*?\\n```)","i"),c=i.match(r);if(c){let l=c.index+c[0].length,d=i.substring(0,l),m=i.substring(l);return d+"\n\n```"+e+`
`+s+"\n```"+m}return i+"\n\n```"+e+`
`+s+"\n```\n"}generateMldText(i){let t=[];for(let e of i.tables){t.push(`TABLE ${e.name} {`);for(let s of e.columns){let n=`    ${s.name}`,r=[];s.isPrimaryKey&&r.push("[PK]"),s.foreignKey&&r.push(`[FK -> ${s.foreignKey.referencedTable}.${s.foreignKey.referencedColumn}]`),r.length>0&&(n+=" "+r.join(" ")),t.push(n)}t.push("}"),t.push("")}return t.join(`
`).trim()}generateMpdText(i){let t=[];for(let e of i.tables){t.push(`TABLE ${e.name} {`);for(let s of e.columns){let n=`    ${s.name} ${s.sqlType}`,r=[];s.isPrimaryKey&&r.push("[PK]");for(let c of s.constraints)c.type==="NOT NULL"&&r.push("[NOT NULL]"),c.type==="UNIQUE"&&r.push("[UNIQUE]"),c.type==="CHECK"&&c.expression&&r.push(`[CHECK(${c.expression})]`);if(s.foreignKey){let c=`[FK -> ${s.foreignKey.referencedTable}.${s.foreignKey.referencedColumn}`;s.foreignKey.onDelete&&(c+=` ON DELETE ${s.foreignKey.onDelete}`),s.foreignKey.onUpdate&&(c+=` ON UPDATE ${s.foreignKey.onUpdate}`),c+="]",r.push(c)}r.length>0&&(n+=" "+r.join(" ")),t.push(n)}t.push("}"),t.push("")}return t.join(`
`).trim()}};
